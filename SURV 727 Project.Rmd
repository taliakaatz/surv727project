---
title: "SURV 727 Project"
author: "Talia Kaatz and Chris Brehm"
date: "12/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readr)
library(knitr)
library(DBI)
library(dbplyr)
library(bigrquery)
library(sf)
library(magrittr)
library(censusapi)

```

## Initializing project in github and rmarkdown file

read in data from git repository

```{r, import data}

county_hv <- read_csv("https://raw.githubusercontent.com/taliakaatz/surv727project/master/county%20HV.csv")
county_rv <- read_csv("https://raw.githubusercontent.com/taliakaatz/surv727project/master/county%20RV.csv")
nhood_hv <- read_csv("https://raw.githubusercontent.com/taliakaatz/surv727project/master/neighborhood%20HV.csv")
nhood_rv <- read_csv("https://raw.githubusercontent.com/taliakaatz/surv727project/master/neighborhood%20RV.csv")


```


subset data to metro area (county level) and baltimore city (neighborhood level) and reshape to long format with full date, year, and month variables. also clean some superfluous variables



```{r, preprocess zillow data}

RVmetro <- 
  county_rv %>% 
    filter(Metro %in% "Baltimore-Columbia-Towson") %>%
    gather(key = "date", value = "RentalValue", 8:117) %>%
    select(- State, -Metro, -StateCodeFIPS) %>%
    separate(date, into = c("year", "month"), sep = "-", remove = FALSE) %>%
    arrange(RegionName, desc(date))

HVmetro <- 
  county_hv %>% 
    filter(Metro %in% "Baltimore-Columbia-Towson") %>%
    gather(key = "date", value = "HomeValue", 8:290) %>%
    select(- State, -Metro, -StateCodeFIPS) %>%
    separate(date, into = c("year", "month"), sep = "-", remove = FALSE) %>%
    arrange(RegionName, desc(date))

RVbmore  <-
  nhood_rv %>% 
    filter(City %in% "Baltimore" & State %in% "MD") %>%
    gather(key = "date", value = "RentalValue", 8:117) %>%
    select(-State, -Metro, -City, -CountyName) %>%
    separate(date, into = c("year", "month"), sep = "-", remove = FALSE) %>%
    arrange(RegionName, desc(date))

HVbmore <-
  nhood_hv %>% 
    filter(City %in% "Baltimore") %>%
    gather(key = "date", value = "HomeValue", 8:290) %>%
    select(-State, -Metro, -City, -CountyName) %>%
    separate(date, into = c("year", "month"), sep = "-", remove = FALSE) %>%
    arrange(RegionName, desc(date))

```


begin exploring data visualizations -- work in progress

```{r}

#line plot of home values in baltimore city over the course of 2018, broken out by neighborhood
HVbmore %>%
  filter(year == "2018") %>%
  ggplot() +
  geom_line(aes(x = month, y = HomeValue, group = RegionName, color = HomeValue))



```


first attempts at mapping visualizations -- work in progress


```{r}


#read in shapefile as a "simple feature"    
bmore_sf <- st_read("/Users/taliakaatz/Desktop/Computation & Data Display/Project Folder/baltimore city shape files/Maryland_Baltimore_City_Neighborhoods.shp")

#plot each aspect of shapefile
plot(bmore_sf)

##attempted to extract long/lat coordinates as X,Y values to append to zillow data and use in ggplot, was not successful
#sf1 <- bmore_sf[1,]
#sf1 <- st_cast(sf1, "POINT")
#st_write(sf1, "/Users/taliakaatz/Desktop/Computation & Data Display/Project Folder/baltimore city shape files/geo baltimore city.csv", layer_options = "GEOMETRY=AS_XY")
  
#bmore_map <- read.csv("/Users/taliakaatz/Desktop/Computation & Data Display/Project Folder/baltimore city shape files/geo baltimore city.csv")

#clean neighborhood names 

RVbmore %<>% 
  mutate(NHOOD = trimws(toupper(RegionName)))

bmore_sf %<>%
  mutate(NHOOD = trimws(toupper(LABEL)))

#check the shapefile names against the zillow names

hoodnames <- unique(RVbmore$NHOOD)
hoodnames[!(hoodnames %in% bmore_sf$NHOOD)]

othhoodnames <- unique(bmore_sf$NHOOD)
othhoodnames[!(othhoodnames %in% RVbmore$NHOOD)]

#adjust non-matches (zillow neighborhood names not matched to any in shaefile) as necessary and check results
### will basically have to re-do this with the BNIA shapefile :( lol

RVbmore %<>%
  mutate(NHOOD = gsub("COPPIN HEIGHTS - ASH-CO-EAST", "COPPIN HEIGHTS/ASH-CO-EAST", NHOOD)) %>%
  mutate(NHOOD = gsub("ELLWOOD PARK-MONUMENT", "ELLWOOD PARK/MONUMENT", NHOOD)) %>%
  mutate(NHOOD = gsub("GLENHAM-BELFORD", "GLENHAM-BELHAR", NHOOD)) %>%
  mutate(NHOOD = gsub("MONDAWIN", "MONDAWMIN", NHOOD)) %>%
  mutate(NHOOD = gsub("NEW SOUTHWEST - MOUNT CLARE", "NEW SOUTHWEST/MOUNT CLARE", NHOOD)) %>%
  mutate(NHOOD = gsub("PENROSE-FAYETTE STREET OUTREACH", "PENROSE/FAYETTE STREET OUTREACH", NHOOD)) %>%
  mutate(NHOOD = gsub("SBIC", "SOUTH BALTIMORE", NHOOD)) %>%
  mutate(NHOOD = gsub("WASHINGTON VILLAGE", "WASHINGTON VILLAGE/PIGTOWN", NHOOD)) %>%
  mutate(NHOOD = gsub("WOODRING", "WESTFIELD", NHOOD))

hoodnames <- unique(RVbmore$NHOOD)
hoodnames[!(hoodnames %in% bmore_sf$NHOOD)]
##based on output, still need to resolve "HARFORD-ECHODALE - PERRING PARKWAY" -- need to determine which neighborhood that area falls under in shapefile

##examples of how to plot a single attribute of shapefile using 'plot' and 'ggplot', other output specifications (fill, etc.) can be added -- neither of these display useful info yet, they just color-code each neighborhood individually by the neighborhood name

#using plot
plot(bmore_sf['LABEL'])

#using ggplot
bmore_sf %>%
  ggplot() +
    geom_sf(aes(fill = LABEL), show.legend = FALSE)
  

##attempt to joing zillow data and plot rental values
bmore_sf %>%
  left_join(RVbmore, by = "NHOOD") %>%
  filter(date == "2018-01") %>%
  ggplot() +
    geom_sf(aes(fill = RentalValue))


```

##Adding Demographics

```{r}

#talia updated code to keep Metro variable and to subset to only 2010-2018
RVMD <-
  county_rv %>% 
    filter(State %in% "MD") %>%
    gather(key = "date", value = "RentalValue", 8:117) %>%
    select(-State, -StateCodeFIPS, -MunicipalCodeFIPS, -SizeRank) %>%
    separate(date, into = c("year", "month"), sep = "-", remove = FALSE) %>%
    filter(year %in% 2010:2018) %>%
    arrange(RegionName, desc(date))

HVMD <-
  county_hv %>% 
    filter(State %in% "MD") %>%
    gather(key = "date", value = "HomeValue", 8:290) %>%
    select(-State, -StateCodeFIPS, -MunicipalCodeFIPS, -SizeRank) %>%
    separate(date, into = c("year", "month"), sep = "-", remove = FALSE) %>%
    filter(year %in% 2010:2018) %>%
    arrange(RegionName)
```

```{r}
cs_key <- "a57bdfaf40991f97bfd12e41478426c81badd18a"
count_md18 <- getCensus(name = "2018/acs/acs1/profile",
                      vars = c("DP05_0037PE", "DP05_0071PE", "DP05_0018E"),#%white, %hisp, median age
                      region = "county:*", 
                      regionin = "state:24",
                      key = cs_key)[-c(1:2)]

count_md17 <- getCensus(name = "2017/acs/acs1/profile",
                      vars = c("DP05_0037PE", "DP05_0071PE", "DP05_0018E"),#%white, %hisp, median age
                      region = "county:*", 
                      regionin = "state:24",
                      key = cs_key)[-c(1:2)]

count_md16 <- getCensus(name = "2016/acs/acs1/profile",
                      vars = c("DP05_0032PE", "DP05_0066PE", "DP05_0017E"),#%white, %hisp, median age
                      region = "county:*", 
                      regionin = "state:24",
                      key = cs_key)[-c(1:2)]

count_md15 <- getCensus(name = "2015/acs/acs1/profile",
                      vars = c("DP05_0032PE", "DP05_0066PE", "DP05_0017E"),#%white, %hisp, median age
                      region = "county:*", 
                      regionin = "state:24",
                      key = cs_key)[-c(1:2)]

count_md14 <- getCensus(name = "2014/acs/acs1/profile",
                      vars = c("DP05_0032PE", "DP05_0066PE", "DP05_0017E"),#%white, %hisp, median age
                      region = "county:*", 
                      regionin = "state:24",
                      key = cs_key)[-c(1:2)]

count_md13 <- getCensus(name = "2013/acs/acs1/profile",
                      vars = c("DP05_0032PE", "DP05_0066PE", "DP05_0017E"),#%white, %hisp, median age
                      region = "county:*", 
                      regionin = "state:24",
                      key = cs_key)[-c(1:2)]

count_md12 <- getCensus(name = "2012/acs/acs1/profile",
                      vars = c("DP05_0032PE", "DP05_0066PE", "DP05_0017E"),#%white, %hisp, median age
                      region = "county:*", 
                      regionin = "state:24",
                      key = cs_key)[-c(1:2)]

count_md11 <- getCensus(name = "2011/acs/acs1/profile",
                      vars = c("DP05_0032PE", "DP05_0066PE", "DP05_0017E"),#%white, %hisp, median age
                      region = "county:*", 
                      regionin = "state:24",
                      key = cs_key)[-c(1:2)]

count_md10 <- getCensus(name = "2010/acs/acs1/profile",
                      vars =c("DP05_0032PE", "DP05_0066PE", "DP05_0017E"),#%white, %hisp, median age
                      region = "county:*", 
                      regionin = "state:24",
                      key = cs_key)[-c(1:2)]

count_md10$CountyName <- c("Allegany County","Anne Arundel County", "Baltimore County", "Calvert County", "Carroll County", "Cecil County", "Charles County", "Frederick County", "Harford County", "Howard County", "Montgomery County", "Prince George's County", "Saint Mary's County", "Washington County", "Wicomico County", "Baltimore City")

count_md11$CountyName <- c("Allegany County","Anne Arundel County", "Baltimore County", "Calvert County", "Carroll County", "Cecil County", "Charles County", "Frederick County", "Harford County", "Howard County", "Montgomery County", "Prince George's County", "Saint Mary's County", "Washington County", "Wicomico County", "Baltimore City")

count_md12$CountyName <- c("Allegany County","Anne Arundel County", "Baltimore County", "Calvert County", "Carroll County", "Cecil County", "Charles County", "Frederick County", "Harford County", "Howard County", "Montgomery County", "Prince George's County", "Saint Mary's County", "Washington County", "Wicomico County", "Baltimore City")

count_md13$CountyName <- c("Allegany County","Anne Arundel County", "Baltimore County", "Calvert County", "Carroll County", "Cecil County", "Charles County", "Frederick County", "Harford County", "Howard County", "Montgomery County", "Prince George's County", "Saint Mary's County", "Washington County", "Wicomico County", "Baltimore City")

count_md14$CountyName <- c("Allegany County","Anne Arundel County", "Baltimore County", "Calvert County", "Carroll County", "Cecil County", "Charles County", "Frederick County", "Harford County", "Howard County", "Montgomery County", "Prince George's County", "Saint Mary's County", "Washington County", "Wicomico County", "Baltimore City")

count_md15$CountyName <- c("Allegany County","Anne Arundel County", "Baltimore County", "Calvert County", "Carroll County", "Cecil County", "Charles County", "Frederick County", "Harford County", "Howard County", "Montgomery County", "Prince George's County", "Saint Mary's County", "Washington County", "Wicomico County", "Baltimore City")

count_md16$CountyName <- c("Allegany County","Anne Arundel County", "Baltimore County", "Calvert County", "Carroll County", "Cecil County", "Charles County", "Frederick County", "Harford County", "Howard County", "Montgomery County", "Prince George's County", "Saint Mary's County", "Washington County", "Wicomico County", "Baltimore City")

count_md17$CountyName <- c("Allegany County","Anne Arundel County", "Baltimore County", "Calvert County", "Carroll County", "Cecil County", "Charles County", "Frederick County", "Harford County", "Howard County", "Montgomery County", "Prince George's County", "Saint Mary's County", "Washington County", "Wicomico County", "Baltimore City")

count_md18$CountyName <- c("Allegany County","Anne Arundel County", "Baltimore County", "Calvert County", "Carroll County", "Cecil County", "Charles County", "Frederick County", "Harford County", "Howard County", "Montgomery County", "Prince George's County", "Saint Mary's County", "Washington County", "Wicomico County", "Baltimore City")



```


```{r}
HVMD$nonwhite <- NA
HVMD$hispanic <- NA
HVMD$medianage <- NA
RVMD$nonwhite <- NA
RVMD$hispanic <- NA
RVMD$medianage <- NA

for(i in 1:length(HVMD$RegionName)){
  if(HVMD$RegionName[i] %in% count_md10$CountyName){
    if(HVMD$year[i] == 2010){
      HVMD$nonwhite[i] <- 100 - count_md10$DP05_0032PE[count_md10$CountyName == HVMD$RegionName[i]]
      HVMD$hispanic[i] <- count_md10$DP05_0066PE[count_md10$CountyName == HVMD$RegionName[i]]
      HVMD$medianage[i] <- count_md10$DP05_0017E[count_md10$CountyName == HVMD$RegionName[i]]
    }
    else if(HVMD$year[i] == 2011){
      HVMD$nonwhite[i] <- 100 - count_md11$DP05_0032PE[count_md11$CountyName == HVMD$RegionName[i]]
      HVMD$hispanic[i] <- count_md11$DP05_0066PE[count_md11$CountyName == HVMD$RegionName[i]]
      HVMD$medianage[i] <- count_md11$DP05_0017E[count_md11$CountyName == HVMD$RegionName[i]]
    }
    else if(HVMD$year[i] == 2012){
      HVMD$nonwhite[i] <- 100 - count_md12$DP05_0032PE[count_md12$CountyName == HVMD$RegionName[i]]
      HVMD$hispanic[i] <- count_md12$DP05_0066PE[count_md12$CountyName == HVMD$RegionName[i]]
      HVMD$medianage[i] <- count_md12$DP05_0017E[count_md12$CountyName == HVMD$RegionName[i]]
    }
    else if(HVMD$year[i] == 2013){
      HVMD$nonwhite[i] <- 100 - count_md13$DP05_0032PE[count_md13$CountyName == HVMD$RegionName[i]]
      HVMD$hispanic[i] <- count_md13$DP05_0066PE[count_md13$CountyName == HVMD$RegionName[i]]
      HVMD$medianage[i] <- count_md13$DP05_0017E[count_md13$CountyName == HVMD$RegionName[i]]
    }
    else if(HVMD$year[i] == 2014){
      HVMD$nonwhite[i] <- 100 - count_md14$DP05_0032PE[count_md14$CountyName == HVMD$RegionName[i]]
      HVMD$hispanic[i] <- count_md14$DP05_0066PE[count_md14$CountyName == HVMD$RegionName[i]]
      HVMD$medianage[i] <- count_md14$DP05_0017E[count_md14$CountyName == HVMD$RegionName[i]]
    }
    else if(HVMD$year[i] == 2015){
      HVMD$nonwhite[i] <- 100 - count_md15$DP05_0032PE[count_md15$CountyName == HVMD$RegionName[i]]
      HVMD$hispanic[i] <- count_md15$DP05_0066PE[count_md15$CountyName == HVMD$RegionName[i]]
      HVMD$medianage[i] <- count_md15$DP05_0017E[count_md15$CountyName == HVMD$RegionName[i]]
    }
    else if(HVMD$year[i] == 2016){
      HVMD$nonwhite[i] <- 100 - count_md16$DP05_0032PE[count_md16$CountyName == HVMD$RegionName[i]]
      HVMD$hispanic[i] <- count_md16$DP05_0066PE[count_md16$CountyName == HVMD$RegionName[i]]
      HVMD$medianage[i] <- count_md16$DP05_0017E[count_md16$CountyName == HVMD$RegionName[i]]
    }
    else if(HVMD$year[i] == 2017){
      HVMD$nonwhite[i] <- 100 - count_md17$DP05_0037PE [count_md17$CountyName == HVMD$RegionName[i]]
      HVMD$hispanic[i] <- count_md17$DP05_0071PE[count_md17$CountyName == HVMD$RegionName[i]]
      HVMD$medianage[i] <- count_md17$DP05_0018E[count_md17$CountyName == HVMD$RegionName[i]]
    }
    else if(HVMD$year[i] == 2018){
      HVMD$nonwhite[i] <- 100 - count_md18$DP05_0037PE[count_md18$CountyName == HVMD$RegionName[i]]
      HVMD$hispanic[i] <- count_md18$DP05_0071PE[count_md18$CountyName == HVMD$RegionName[i]]
      HVMD$medianage[i] <- count_md18$DP05_0018E[count_md18$CountyName == HVMD$RegionName[i]]
    }
    
  }
}

for(i in 1:length(RVMD$RegionName)){
  if(RVMD$RegionName[i] %in% count_md10$CountyName){
    if(RVMD$year[i] == 2010){
      RVMD$nonwhite[i] <- 100 - count_md10$DP05_0032PE[count_md10$CountyName == RVMD$RegionName[i]]
      RVMD$hispanic[i] <- count_md10$DP05_0066PE[count_md10$CountyName == RVMD$RegionName[i]]
      RVMD$medianage[i] <- count_md10$DP05_0017E[count_md10$CountyName == RVMD$RegionName[i]]
    }
    else if(RVMD$year[i] == 2011){
      RVMD$nonwhite[i] <- 100 - count_md11$DP05_0032PE[count_md11$CountyName == RVMD$RegionName[i]]
      RVMD$hispanic[i] <- count_md11$DP05_0066PE[count_md11$CountyName == RVMD$RegionName[i]]
      RVMD$medianage[i] <- count_md11$DP05_0017E[count_md11$CountyName == RVMD$RegionName[i]]
    }
    else if(RVMD$year[i] == 2012){
      RVMD$nonwhite[i] <- 100 - count_md12$DP05_0032PE[count_md12$CountyName == RVMD$RegionName[i]]
      RVMD$hispanic[i] <- count_md12$DP05_0066PE[count_md12$CountyName == RVMD$RegionName[i]]
      RVMD$medianage[i] <- count_md12$DP05_0017E[count_md12$CountyName == RVMD$RegionName[i]]
    }
    else if(RVMD$year[i] == 2013){
      RVMD$nonwhite[i] <- 100 - count_md13$DP05_0032PE[count_md13$CountyName == RVMD$RegionName[i]]
      RVMD$hispanic[i] <- count_md13$DP05_0066PE[count_md13$CountyName == RVMD$RegionName[i]]
      RVMD$medianage[i] <- count_md13$DP05_0017E[count_md13$CountyName == RVMD$RegionName[i]]
    }
    else if(RVMD$year[i] == 2014){
      RVMD$nonwhite[i] <- 100 - count_md14$DP05_0032PE[count_md14$CountyName == RVMD$RegionName[i]]
      RVMD$hispanic[i] <- count_md14$DP05_0066PE[count_md14$CountyName == RVMD$RegionName[i]]
      RVMD$medianage[i] <- count_md14$DP05_0017E[count_md14$CountyName == RVMD$RegionName[i]]
    }
    else if(RVMD$year[i] == 2015){
      RVMD$nonwhite[i] <- 100 - count_md15$DP05_0032PE[count_md15$CountyName == RVMD$RegionName[i]]
      RVMD$hispanic[i] <- count_md15$DP05_0066PE[count_md15$CountyName == RVMD$RegionName[i]]
      RVMD$medianage[i] <- count_md15$DP05_0017E[count_md15$CountyName == RVMD$RegionName[i]]
    }
    else if(RVMD$year[i] == 2016){
      RVMD$nonwhite[i] <- 100 - count_md16$DP05_0032PE[count_md16$CountyName == RVMD$RegionName[i]]
      RVMD$hispanic[i] <- count_md16$DP05_0066PE[count_md16$CountyName == RVMD$RegionName[i]]
      RVMD$medianage[i] <- count_md16$DP05_0017E[count_md16$CountyName == RVMD$RegionName[i]]
    }
    else if(RVMD$year[i] == 2017){
      RVMD$nonwhite[i] <- 100 - count_md17$DP05_0037PE [count_md17$CountyName == RVMD$RegionName[i]]
      RVMD$hispanic[i] <- count_md17$DP05_0071PE[count_md17$CountyName == RVMD$RegionName[i]]
      RVMD$medianage[i] <- count_md17$DP05_0018E[count_md17$CountyName == RVMD$RegionName[i]]
    }
    else if(RVMD$year[i] == 2018){
      RVMD$nonwhite[i] <- 100 - count_md18$DP05_0037PE[count_md18$CountyName == RVMD$RegionName[i]]
      RVMD$hispanic[i] <- count_md18$DP05_0071PE[count_md18$CountyName == RVMD$RegionName[i]]
      RVMD$medianage[i] <- count_md18$DP05_0018E[count_md18$CountyName == RVMD$RegionName[i]]
    }
    
  }
}
HVMD$nonwhite[HVMD$nonwhite > 100] <- NA
RVMD$nonwhite[RVMD$nonwhite > 100] <- NA
```

##visualizations for hypothesis #1: County-level rental values will show a greater increase over time than housing values over the same period

```{r}

year_breaks <- c("2010-01", "2011-01", "2012-01", "2013-01", "2014-01", "2015-01", "2016-01", "2017-01", "2018-01")

HVMD %>%
  left_join(RVMD, by = c("RegionName", "date")) %>%
  mutate(hrv_ratio = (RentalValue/(HomeValue/1000))) %>%
  filter(Metro.x %in% "Baltimore-Columbia-Towson") %>%
  ggplot() +
  geom_jitter(aes(x = date, y = hrv_ratio , group = RegionName, color = RegionName)) + 
  ggtitle("Change in Rental-to-Homevalue Ratio Over Time in Baltimore Metro") + 
  scale_x_discrete("Date", c('2010', year_breaks, year_breaks)) + 
  ylab("Ratio of rental values to home values")

HVMD %>%
  left_join(RVMD, by = c("RegionName", "date")) %>%
  filter(Metro.x %in% "Baltimore-Columbia-Towson") %>%
  ggplot() +
  geom_jitter(aes(x = date, y = RentalValue , group = RegionName, color = RegionName)) + 
  ggtitle("Rental Values Over Time in Baltimore Metro") + 
  scale_x_discrete("Date", c('2010', year_breaks, year_breaks)) + 
  ylab("Average rental Values (monthly rent in $)")

HVMD %>%
  left_join(RVMD, by = c("RegionName", "date")) %>%
  filter(Metro.x %in% "Baltimore-Columbia-Towson") %>%
  ggplot() +
  geom_jitter(aes(x = date, y = (HomeValue/1000) , group = RegionName, color = RegionName)) + 
  ggtitle("Home Values Ratio Over Time in Baltimore Metro") + 
  scale_x_discrete("Date", c('2010', year_breaks, year_breaks)) + 
  ylab("Average home value (in thousands)")


```

##visualizations for hypothesis #2: This effect will be more pronounced in urban than in rural counties

```{r}

#pull MD county map data from 'maps' package
md_map <- map_data("county", region = "maryland")

#map filling MD counties by average rental values in Jan 2019
HVMD %>%
    left_join(RVMD, by = c("RegionName", "date")) %>%
    mutate(hrv_ratio = (RentalValue/(HomeValue/1000))) %>%
    mutate(subregion = gsub(" County", "", RegionName)) %>%
    mutate(subregion = tolower(subregion)) %>%
    right_join(md_map, by = "subregion") %>%
    filter(date %in% c("2018-12", "2015-12")) %>%
    ggplot() + 
      geom_polygon(aes(x = long, y = lat, group = subregion, fill = hrv_ratio)) +
      facet_wrap(~date, scale = "free") +
      ggtitle("MD Rental-to-HomeValue Ratios in Dec. 2015 and Dec. 2018") +
      scale_fill_continuous(name = "RTHV Ratio")


```

